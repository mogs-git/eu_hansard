---
title: "Brexit: A Textual Analysis (Part I)"
output: html_notebook
---
This project explores the language used in the EU [withdrawal bill debate](https://hansard.parliament.uk/lords/2017-03-01/debates/EE9DF3A9-2E05-4568-8CF8-A61F11172391/EuropeanUnion(NotificationOfWithdrawal)Bill). It was motivated by a need to break down the rhetoric into what is important, and see how different groups of speakers within the Lords (whether these be groups from the same party, the same gender etc…) respond differently to the issues. *Why not just read the debate?* I strongly recommend you do indeed read the debate itself. However, text analysis is powerful for several reasons. Firstly, it is time consuming to read a 12 hour debate the whole way through. Secondly, there is simply too much information contained within the debate for a single human mind to efficiently spot all the patterns within the data. As such, text mining offers a way to summarise these meaningful patterns and ideas. 

That is not to say text mining is without problems. By definition, when we summarise the text in some way, we lose information. However, by asking questions that are clear, transparent, and meaningful and being measured about the conclusions we draw, the approach can yield insights that would otherwise be hard to discern. As well as informing people about the Brexit debate, this article also aims to showcase the huge amount of information that can be found in a single structured text file.  

Be sure to use the [glossary](#glossary) at the bottom of the page when you haven’t heard of a term before. If you want to read more about the debates in the Lords or Commons, go to the Government's official website https://hansard.parliament.uk/ or take a look at some of the brilliant work being done at https://www.theyworkforyou.com/


```{r load in the data, echo = FALSE, message=FALSE, warning=FALSE, error=F}
pacman::p_load(tidyverse, magrittr, tidytext, stringr, igraph, ggraph, tidygraph, grid, gridExtra, ggpubr)
source("scripts/hansard_src.R")

full_speeches <- readRDS("..//data//full_speeches.RDAT")
appearances_tib <- readRDS("..//data//appearances.RDAT")
appearances_tib_f <- readRDS("..//data//appearances_f.RDAT")
gender_id_tib <- appearances_tib %>% select(name, gender)
party_id_tib <- readRDS("..//data//party_id_tib.RDAT")
party_id <- select(party_id_tib, name, party)
`%!in%` <- negate(`%in%`)

source("..//scripts/hansard_src.R")
main_parties <- c("(Con)", "(Lab)", "(CB)", "(LD)")
party_cols <- c("dodgerblue3", "chartreuse3", "goldenrod1", "firebrick2", "grey30")
appearances_tib_fp <- appearances_tib_f %>% select(-party) %>% rename(party = party_f)

# rmd settings
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```

## Part 1: Counting things

### Who turned up? 


```{r team_composition, echo = FALSE, fig.width=12, fig.height=5}
full_speeches %>% group_by(party, gender) %>% summarise(n = n()) %>%
  ggplot(aes(party, n)) +
  geom_col(aes(fill = gender)) +
  ylab("# members") +
  scale_y_continuous(breaks = seq(0,30,5)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_classic()

```

In total, ninety-three lords and ladies participated in the debate. Of the parties, the conservatives had the largest turnout (29% of the house), but labour, the liberal democrats and the [crossbench](#crossbench) also boasted significant numbers of speakers (25%, 20% and a further 20% of the house respectively). Interestingly, the liberal democrats and labour brought the vast majority of female representation to the house. 

## Who spoke the most? {.tabset .tabset-fade}

### Figure 1 {.tabset}
```{r num_speeches, echo = FALSE, fig.width=12, fig.height=5}
# how often did each party speak?

speeches_by_party <- appearances_tib_f %>% group_by(party) %>% summarise(n_speeches = n())

# how often would you expect each to speak based on number of lords present?

exp_speeches <- appearances_tib_f %>% distinct(name, party) %>% group_by(party) %>% summarise(n = n()) %>%
  mutate(total_speeches = 247, nprob = n/sum(n), expected_nspeeches = round(total_speeches*nprob)) 

p1 <- speeches_by_party %>% left_join(exp_speeches, by = "party") %>% select(party,n_speeches,expected_nspeeches) %>% 
  gather(speech_type, count, n_speeches, expected_nspeeches) %>%
  ggplot(aes(party, count)) + geom_col(aes(fill = speech_type), position = "dodge") +
  scale_y_continuous(name="Number of speeches") + 
  theme_pubr() 

words_per_speech <- appearances_tib_f %>% mutate(r = row_number()) %>% unnest_tokens(word, speeches) %>% 
  group_by(r, name) %>% summarise(word_count = n()) %>% filter(!is.na(name)) %>% ungroup() %>% add_gender()

words_per_lord <- words_per_speech %>% group_by(name) %>% summarise(word_count = sum(word_count)) %>% filter(!is.na(name))

words_per_lord %<>% add_gender()
words_per_lord %<>% mutate(name =  as.factor(name))

p2 <- words_per_lord %>% left_join(party_id) %>% group_by(party) %>% summarise(total_words = sum(word_count), total_speakers = length(name)) %>% ungroup() %>%
  mutate(tot_s = sum(total_speakers), tot_w = sum(total_words), exp = tot_w*(total_speakers/tot_s)) %>% gather(type, count, total_words, exp) %>%
  ggplot(aes(party, count)) + geom_col(aes(fill = type), position = 'dodge') +
  scale_fill_manual(labels = c("expected", "actual"), values = c("red", "blue")) +
  scale_y_continuous(name="Number of words") +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#grid.arrange(p1, p2, ncol = 2)
p1
```

### Figure 2 {.tabset}
```{r}
# appearances_tib_fp %>% group_by(name) %>% summarise(party = unique(party), n = n()) %>% pull(n) %>% median()

# appearances_tib_fp %>% group_by(name) %>% summarise(party = unique(party), n = n()) %>% arrange(desc(n)) %>% filter(n >= 3) %>% group_by(party) %>% summarise(n = n())

# full_speeches %>% group_by(party_f) %>% count() %>% ungroup() %>% mutate(n/sum(n))
# appearances_tib_fp %>% group_by(name) %>% summarise(party = unique(party), n = n()) %>% arrange(desc(n)) %>% filter(n >= 3) %>% group_by(party) %>% summarise(n = n()) %>% ungroup() %>% mutate(n / sum(n))

appearances_tib_fp %>% group_by(name) %>% summarise(party = unique(party), n = n()) %>% arrange(desc(n)) %>% filter(n >= 3)
```


##

Which individuals, party members, or gender spoke the most? There are several ways to answer this question using the [Hansard](#hansard). The first is to look at the raw number of speeches an individual or group made. When considering different groups of speakers (for instance, the labour party vs the conservative party), it is important to remember that each group is present in different numbers. This affects how we think about the results, for example: if the conservatives have 4% more speakers than the labour party, we would expect to see them give 4% more of the speeches.

However, even taking into account the disproportionate numbers of speakers for each party in the lords, the conservatives still speak more often than we would expect. This in turn means that other parties spoke disproportionately less often than what would happen if speeches were perfectly fairly distributed among each group present. This is ultimately reflected in a table of all the lords who spoke more than or equal to the median number of speeches made per lord, there are 12 conservatives, but a maximum of 4 speakers from any other party in this upper group. Looking at this subset who spoke most, 46% are tories, even though they make up only 29% of the house.

**Example calculation:** 
*There were 27 tory MPs, so `27 / 93 = 0.29` of the speakers present are Conservatives. 
If there were 247 speeches throughout the day we would expect `0.29 * 247 = 72` speeches to be given by Conservative MPs.*

In reality this number was closer to 100. Let’s look into this in more detail…

## Who spoke the most (part II)? {.tabset .tabset-fade}

I mentioned that there are several ways of understanding who spoke most. As well as looking at number of speeches throughout the day, we can also explore who used the most words in their speeches. When combined with the above analysis, this is very informative. 

Unsurprisingly, the conservative party used more words than we would expect and other parties used less. We can also look back at the gender representation to see if our earlier findings that female speakers are underepresented still holds true when counting number of words used. 

### Figure 2 {.tabset}
```{r}
wordExpectationPlot <- words_per_lord %>% group_by(gender) %>% summarise(total_words = sum(word_count), total_speakers = length(name)) %>% ungroup() %>%
  mutate(tot_s = sum(total_speakers), tot_w = sum(total_words), exp = tot_w*(total_speakers/tot_s)) %>% gather(type, count, total_words, exp) %>%
  ggplot(aes(gender, count)) + geom_col(aes(fill = type), position = 'dodge') + theme_pubr()

speechesExpectationPlot <- appearances_tib %>% group_by(gender) %>% summarise(n_speeches = length(name), n_speakers = length(unique(name))) %>% ungroup() %>% 
  mutate(tot_s = sum(n_speeches), exp = tot_s * n_speakers/sum(n_speakers)) %>%
  gather(type, count, n_speeches, exp) %>%
  ggplot(aes(gender, count)) + geom_col(aes(fill = type), position = 'dodge') + theme_pubr()

grid.arrange(wordExpectationPlot, speechesExpectationPlot, ncol = 2)
```

### Figure 3 {.tabset}
```{r gender}
# wordCountPlot <- words_per_lord %>% ggplot(aes(x = fct_reorder(name, word_count), y = word_count)) + geom_col(aes(fill = gender)) + theme(legend.position="none")
# 
p2 


wps_expected_gender <- words_per_speech %>% group_by(gender) %>% arrange(gender, word_count) %>% mutate(r = row_number(), p = r/length(r)) %>% ggplot(aes(word_count, p)) + geom_line(aes(colour = gender)) + geom_point(aes(colour = gender)) +
  geom_hline(yintercept = 0.5) + theme_pubr()

wpl_expected_gender <- words_per_lord %>% group_by(gender) %>% arrange(gender, word_count) %>% mutate(r = row_number(), p = r/length(r)) %>% ggplot(aes(word_count, p)) + geom_line(aes(colour = gender)) + geom_point(aes(colour = gender)) + theme_pubr()

words_per_speech %<>% left_join(party_id)
wps_expected_party <- words_per_speech %>% filter(party %in% main_parties) %>% group_by(party) %>% arrange(party, word_count) %>% mutate(r = row_number(), p = r/length(r)) %>% ggplot(aes(word_count, p)) + geom_line(aes(colour = party)) + geom_point(aes(colour = party)) + theme_pubr()


grid.arrange(wps_expected_gender, wpl_expected_gender, ncol = 2)
```

### Figure 4 {.tabset}

```{r}
grid.arrange(wps_expected_party, p2, ncol = 2)
```


##

As well as giving less total speeches than male MPs, female MPs gave even less speeches than we would expect given their numbers if speeches were fairly distributed. However, they made up for this by speaking more than expected on the limited occasions they were given the chance.  

If we look more closely at the distribution of the total number of words said by each speaker, we can see that when looking at individual speeches, females generally manage to fit more words in, with 50% using over 340 words, where the male 50% mark sits at 110 words. Having said this, if we instead look at the distribution of total words used per lord/lady, we can see that on the whole the contributions of individuals from each gender are largely following the same pattern, except for a handful of baronesses who manage to contribute more than expected in their combined speeches. It is worth noting the fragility of this pattern, it might appear that females say more words than men, but this effect is due largely to only four women, and so one can imagine the effect could easily be lost if one were to be absent or be denied a couple of chances to speak. 

In terms of the party representation, as the final ECDF in figure 4 suggests, labour and liberal democrat MPs manage to use more words than conservative and crossbench peers, especially during their longer speeches. However, they still do not use enough to make up for the fact that conservative peers simply spoke less words more often. Therefore in total, conservative peers use slightly more words than we would expect, whereas crossbench lords use far less words than expected and liberal democrats and labour use about what would be expected. 


### A final look at gender representation...

Females made up 24% of the total number of MPs present. There were 22 female speakers compared to 71 male speakers. They gave about 16 less speeches than would be expected given their turnout, which would make a significant increase to the 42 speeches females actually gave. They made up for this by saying about 2000 words more than we would expect in total given their turnout, on average saying more words per speech compared to the men. On the whole, the cumulative distribution of words used is similar for males and females (word counts are spread across speakers in a similar way). However, given the simple sparsity of turnout of female MPs, the loss of a single vocal Baroness could quickly result in females having much less of a say than expected.

## What order did MPs speak in? {.tabset .tabset-fade}

### Figure 5 {.tabset}

```{r, warnings = FALSE, message = FALSE}
party_seq <- appearances_tib_fp$party
party_seq[which(is.na(party_seq))] <- "other"
party_seq_values <- get_seq(party_seq)
party_seq_index <- cumsum(party_seq_values)
party_seq_tib <- tibble(party = party_seq[party_seq_index], run = party_seq_values)

party_seq_tib %<>% mutate(index = row_number())

outplot <- appearances_tib_fp %>%
  mutate(speech_id = row_number()) %>%
  ggplot(aes(speech_id, 1)) +
  geom_col(aes(fill = party), width = 1) + 
  scale_fill_manual(values = party_cols) + 
  theme_pubr()


outplot_condensed <- ggplot(party_seq_tib) +
  geom_col(aes(index, run, fill = party), width = 1) +
  scale_fill_manual(values = party_cols) + 
  theme_pubr()


ggarrange(outplot, outplot_condensed, ncol = 2)
```

### Figure 6 {.tabset}

```{r, warnings = FALSE, message = FALSE}
outhist <- ggplot(party_seq_tib) +
  geom_histogram(aes(run, fill = party)) +
  scale_fill_manual(values = party_cols) + 
  theme_pubr()
outhist
```

### Figure 7 {.tabset}
```{r}
appearances_tib_fp %>% 
  unnest_tokens(word, speeches) %>%
  mutate(r = row_number()) %>%
  ggplot(aes(r, 1)) + 
  geom_col(aes(fill = party), width = 1) + 
  scale_fill_manual(values = party_cols) + 
  theme_pubr()
```

### Figure 8 {.tabset}
```{r}
engagement_per_quarter <- appearances_tib %>% mutate(sec = sections) %>% group_by(sec, party) %>% count() %>%
  ggplot(aes(party, n)) + geom_col(aes(fill = party)) + facet_wrap(~sec) + scale_fill_manual(values = party_cols) + theme_pubr()

# Speeches as a proportion of total made that day by the party
party_numbers <- full_speeches %>% select(-party) %>% rename(party = party_f) %>% group_by(party) %>% summarise(party_total = length(party)) 
party_speeches <- appearances_tib %>% group_by(party) %>% summarise(party_total = length(party)) 
engagement_per_quarter_prop <- appearances_tib %>% mutate(sec = sections) %>% group_by(sec, party) %>% count() %>% 
  left_join(party_speeches) %>% mutate(p = n/party_total) %>%
  ggplot(aes(party, p)) + geom_col(aes(fill = party)) + facet_wrap(~sec) + scale_fill_manual(values = party_cols) + theme_pubr()

ggarrange(engagement_per_quarter,engagement_per_quarter_prop)
```


##

Before we dive into the actual text analysis, there is another class of information we can pull from the Hansard. Because a Hansard is essentially a discussion, or debate, knowing the order people (or groups) spoke in can be informative. When coupled with summaries of what order and for what duration certain topics were spoken about, this information is very powerful (we will look at this later). Above are two simple visualisations describing the order of speech. The plot on the left shows the sequence of speeches in order, coloured by party. On the right I count every consecutive speech by the same party, and condense this into a single bar. Figure 6 shows a simple histogram, coloured by party, showing how often each party gets to make a given number of consecutive speeches. It appears that Conservative speakers are allowed to chain speeches together more often than other parties.

TO explore this effect further, we can make a similar plot (figure 7) but stretch each bar out based on the number of words used in the speech. 

We can also arbitrarily split the debate into quarters, and look at how much each party contributed to each quarter. Based on the raw number of speeches (left) we can see unsurprisingly that the main explanation for who "controlled" each quarter is based simply on turnout for each group. So I also plotted the number a as a proportion of the times the party spoke in total. This means for example, 40% of the speeches made by 'Other' parties were made in the last quarter. Most parties actually sit impressively well around the 25% mark, although labour contributed marginally more than expected in the 2nd quarter, and tories in the 1st and 3rd. Again, this is based solely on unique contributions and without further information like what was being said in each quarter, we are missing a big part of the picture (for instance, *why* did labour speak more in the 2nd quarter?).

One possible implication of having more lords, speaking more often than expected (at shorter lengths) is that this groups ability to control the flow of the discussion by speaking consecutively more often. 

However, there is deeper structure to a debate that will give us an even more meaningful relationship between the speakers and groups involved. Indeed, many of you may be frustrated at how painstaking it is to pull anything but the barest interpretation from the above figures- it's very hard to see exactly who spoke after who most often, and which interactions are most important. To see these things, we need to create a network. 

## The social network of the House of Lords


### Glossary {#glossary}
#### Crossbench (CB) {#crossbench} 
Crossbench Peers are non-party political and by tradition sit on the benches that cross the chamber of the House of Lords. [source](https://www.parliament.uk/site-information/glossary/crossbench-peers/)

#### Privy Council (PC) {#privycouncil}
A collection of senior politicians who are or have been members of the House of Commons or House of Lords. [source](https://en.wikipedia.org/wiki/Privy_Council_of_the_United_Kingdom)

#### Hansard {#hansard}
A Hansard is the official transcript of proceedings of both the House of Commons and the House of Lords. It is named after Thomas Curson Hansard (1776–1833), a London printer and publisher, who was the first official printer to the parliament at Westminster. [source](https://en.wikipedia.org/wiki/Hansard)


